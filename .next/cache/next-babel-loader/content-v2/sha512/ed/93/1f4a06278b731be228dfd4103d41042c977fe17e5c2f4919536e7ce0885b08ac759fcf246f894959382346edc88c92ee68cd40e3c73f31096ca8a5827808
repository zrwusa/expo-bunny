{"ast":null,"code":"\"use strict\";var _interopRequireDefault2=require(\"@babel/runtime/helpers/interopRequireDefault\");var _slicedToArray2=_interopRequireDefault2(require(\"@babel/runtime/helpers/slicedToArray\"));var _interopRequireDefault=require(\"@babel/runtime/helpers/interopRequireDefault\");exports.__esModule=true;exports.initScriptLoader=initScriptLoader;exports.default=void 0;var _extends2=_interopRequireDefault(require(\"@babel/runtime/helpers/extends\"));var _objectWithoutPropertiesLoose2=_interopRequireDefault(require(\"@babel/runtime/helpers/objectWithoutPropertiesLoose\"));var _react=require(\"react\");var _headManagerContext=require(\"../next-server/lib/head-manager-context\");var _headManager=require(\"./head-manager\");var _requestIdleCallback=require(\"./request-idle-callback\");var ScriptCache=new Map();var LoadCache=new Set();var ignoreProps=['onLoad','dangerouslySetInnerHTML','children','onError','strategy'];var loadScript=function loadScript(props){var src=props.src,id=props.id,_props$onLoad=props.onLoad,onLoad=_props$onLoad===void 0?function(){}:_props$onLoad,dangerouslySetInnerHTML=props.dangerouslySetInnerHTML,_props$children=props.children,children=_props$children===void 0?'':_props$children,onError=props.onError;var cacheKey=id||src;if(ScriptCache.has(src)){if(!LoadCache.has(cacheKey)){LoadCache.add(cacheKey);ScriptCache.get(src).then(onLoad,onError);}return;}var el=document.createElement('script');var loadPromise=new Promise(function(resolve,reject){el.addEventListener('load',function(){resolve();if(onLoad){onLoad.call(this);}});el.addEventListener('error',function(){reject();if(onError){onError();}});});if(src){ScriptCache.set(src,loadPromise);LoadCache.add(cacheKey);}if(dangerouslySetInnerHTML){el.innerHTML=dangerouslySetInnerHTML.__html||'';}else if(children){el.textContent=typeof children==='string'?children:Array.isArray(children)?children.join(''):'';}else if(src){el.src=src;}for(var _i=0,_Object$entries=Object.entries(props);_i<_Object$entries.length;_i++){var _ref=_Object$entries[_i];var _ref2=(0,_slicedToArray2.default)(_ref,2);var k=_ref2[0];var value=_ref2[1];if(value===undefined||ignoreProps.includes(k)){continue;}var attr=_headManager.DOMAttributeNames[k]||k.toLowerCase();el.setAttribute(attr,value);}document.body.appendChild(el);};function handleClientScriptLoad(props){var _props$strategy=props.strategy,strategy=_props$strategy===void 0?'afterInteractive':_props$strategy;if(strategy==='afterInteractive'){loadScript(props);}else if(strategy==='lazyOnload'){window.addEventListener('load',function(){(0,_requestIdleCallback.requestIdleCallback)(function(){return loadScript(props);});});}}function loadLazyScript(props){if(document.readyState==='complete'){(0,_requestIdleCallback.requestIdleCallback)(function(){return loadScript(props);});}else{window.addEventListener('load',function(){(0,_requestIdleCallback.requestIdleCallback)(function(){return loadScript(props);});});}}function initScriptLoader(scriptLoaderItems){scriptLoaderItems.forEach(handleClientScriptLoad);}function Script(props){var _props$src=props.src,src=_props$src===void 0?'':_props$src,_props$onLoad2=props.onLoad,onLoad=_props$onLoad2===void 0?function(){}:_props$onLoad2,_props$strategy2=props.strategy,strategy=_props$strategy2===void 0?'afterInteractive':_props$strategy2,onError=props.onError,restProps=(0,_objectWithoutPropertiesLoose2.default)(props,[\"src\",\"onLoad\",\"dangerouslySetInnerHTML\",\"strategy\",\"onError\"]);var _ref3=(0,_react.useContext)(_headManagerContext.HeadManagerContext),updateScripts=_ref3.updateScripts,scripts=_ref3.scripts;(0,_react.useEffect)(function(){if(strategy==='afterInteractive'){loadScript(props);}else if(strategy==='lazyOnload'){loadLazyScript(props);}},[props,strategy]);if(!process.env.__NEXT_SCRIPT_LOADER){return null;}if(strategy==='beforeInteractive'){if(updateScripts){scripts.beforeInteractive=(scripts.beforeInteractive||[]).concat([(0,_extends2.default)({src:src,onLoad:onLoad,onError:onError},restProps)]);updateScripts(scripts);}}return null;}var _default=Script;exports.default=_default;","map":{"version":3,"sources":["../../client/experimental-script.tsx"],"names":["ScriptCache","LoadCache","ignoreProps","loadScript","props","onLoad","children","cacheKey","id","el","document","loadPromise","resolve","reject","onError","dangerouslySetInnerHTML","Array","Object","value","attr","DOMAttributeNames","k","strategy","window","scriptLoaderItems","src","HeadManagerContext","loadLazyScript","process","scripts","updateScripts","Script"],"mappings":"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","sourcesContent":["import React, { useEffect, useContext } from 'react'\nimport { ScriptHTMLAttributes } from 'react'\nimport { HeadManagerContext } from '../next-server/lib/head-manager-context'\nimport { DOMAttributeNames } from './head-manager'\nimport { requestIdleCallback } from './request-idle-callback'\n\nconst ScriptCache = new Map()\nconst LoadCache = new Set()\n\nexport interface Props extends ScriptHTMLAttributes<HTMLScriptElement> {\n  strategy?: 'afterInteractive' | 'lazyOnload' | 'beforeInteractive'\n  id?: string\n  onLoad?: () => void\n  onError?: () => void\n  children?: React.ReactNode\n}\n\nconst ignoreProps = [\n  'onLoad',\n  'dangerouslySetInnerHTML',\n  'children',\n  'onError',\n  'strategy',\n]\n\nconst loadScript = (props: Props): void => {\n  const {\n    src,\n    id,\n    onLoad = () => {},\n    dangerouslySetInnerHTML,\n    children = '',\n    onError,\n  } = props\n\n  const cacheKey = id || src\n  if (ScriptCache.has(src)) {\n    if (!LoadCache.has(cacheKey)) {\n      LoadCache.add(cacheKey)\n      // Execute onLoad since the script loading has begun\n      ScriptCache.get(src).then(onLoad, onError)\n    }\n    return\n  }\n\n  const el = document.createElement('script')\n\n  const loadPromise = new Promise((resolve, reject) => {\n    el.addEventListener('load', function () {\n      resolve()\n      if (onLoad) {\n        onLoad.call(this)\n      }\n    })\n    el.addEventListener('error', function () {\n      reject()\n      if (onError) {\n        onError()\n      }\n    })\n  })\n\n  if (src) {\n    ScriptCache.set(src, loadPromise)\n    LoadCache.add(cacheKey)\n  }\n\n  if (dangerouslySetInnerHTML) {\n    el.innerHTML = dangerouslySetInnerHTML.__html || ''\n  } else if (children) {\n    el.textContent =\n      typeof children === 'string'\n        ? children\n        : Array.isArray(children)\n        ? children.join('')\n        : ''\n  } else if (src) {\n    el.src = src\n  }\n\n  for (const [k, value] of Object.entries(props)) {\n    if (value === undefined || ignoreProps.includes(k)) {\n      continue\n    }\n\n    const attr = DOMAttributeNames[k] || k.toLowerCase()\n    el.setAttribute(attr, value)\n  }\n\n  document.body.appendChild(el)\n}\n\nfunction handleClientScriptLoad(props: Props) {\n  const { strategy = 'afterInteractive' } = props\n  if (strategy === 'afterInteractive') {\n    loadScript(props)\n  } else if (strategy === 'lazyOnload') {\n    window.addEventListener('load', () => {\n      requestIdleCallback(() => loadScript(props))\n    })\n  }\n}\n\nfunction loadLazyScript(props: Props) {\n  if (document.readyState === 'complete') {\n    requestIdleCallback(() => loadScript(props))\n  } else {\n    window.addEventListener('load', () => {\n      requestIdleCallback(() => loadScript(props))\n    })\n  }\n}\n\nexport function initScriptLoader(scriptLoaderItems: Props[]) {\n  scriptLoaderItems.forEach(handleClientScriptLoad)\n}\n\nfunction Script(props: Props): JSX.Element | null {\n  const {\n    src = '',\n    onLoad = () => {},\n    dangerouslySetInnerHTML,\n    strategy = 'afterInteractive',\n    onError,\n    ...restProps\n  } = props\n\n  // Context is available only during SSR\n  const { updateScripts, scripts } = useContext(HeadManagerContext)\n\n  useEffect(() => {\n    if (strategy === 'afterInteractive') {\n      loadScript(props)\n    } else if (strategy === 'lazyOnload') {\n      loadLazyScript(props)\n    }\n  }, [props, strategy])\n\n  if (!process.env.__NEXT_SCRIPT_LOADER) {\n    return null\n  }\n\n  if (strategy === 'beforeInteractive') {\n    if (updateScripts) {\n      scripts.beforeInteractive = (scripts.beforeInteractive || []).concat([\n        {\n          src,\n          onLoad,\n          onError,\n          ...restProps,\n        },\n      ])\n      updateScripts(scripts)\n    }\n  }\n\n  return null\n}\n\nexport default Script\n"]},"metadata":{},"sourceType":"script"}