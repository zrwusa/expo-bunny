{"ast":null,"code":"import _extends from\"@babel/runtime/helpers/extends\";import _defineProperty from\"@babel/runtime/helpers/defineProperty\";import _slicedToArray from\"@babel/runtime/helpers/slicedToArray\";import _classCallCheck from\"@babel/runtime/helpers/classCallCheck\";import _createClass from\"@babel/runtime/helpers/createClass\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly){symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});}keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import _regeneratorRuntime from\"@babel/runtime/regenerator\";import{EventEmitter}from'@unimodules/core';import{assertStatusValuesInBounds,getNativeSourceAndFullInitialStatusForLoadAsync,getUnloadedStatus,PlaybackMixin}from\"../AV\";import ExponentAV from\"../ExponentAV\";import{throwIfAudioIsDisabled}from\"./AudioAvailability\";export var Sound=function(){function Sound(){var _this=this;_classCallCheck(this,Sound);this._loaded=false;this._loading=false;this._key=null;this._lastStatusUpdate=null;this._lastStatusUpdateTime=null;this._subscriptions=[];this._eventEmitter=new EventEmitter(ExponentAV);this._coalesceStatusUpdatesInMillis=100;this._onPlaybackStatusUpdate=null;this._internalStatusUpdateCallback=function(_ref){var key=_ref.key,status=_ref.status;if(_this._key===key){_this._callOnPlaybackStatusUpdateForNewStatus(status);}};this._internalErrorCallback=function(_ref2){var key=_ref2.key,error=_ref2.error;if(_this._key===key){_this._errorCallback(error);}};this._errorCallback=function(error){_this._clearSubscriptions();_this._loaded=false;_this._key=null;_this._callOnPlaybackStatusUpdateForNewStatus(getUnloadedStatus(error));};this.getStatusAsync=function _callee(){var status;return _regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!_this._loaded){_context.next=2;break;}return _context.abrupt(\"return\",_this._performOperationAndHandleStatusAsync(function(){return ExponentAV.getStatusForSound(_this._key);}));case 2:status=getUnloadedStatus();_this._callOnPlaybackStatusUpdateForNewStatus(status);return _context.abrupt(\"return\",status);case 5:case\"end\":return _context.stop();}}},null,null,null,Promise);};}_createClass(Sound,[{key:\"_callOnPlaybackStatusUpdateForNewStatus\",value:function _callOnPlaybackStatusUpdateForNewStatus(status){var shouldDismissBasedOnCoalescing=this._lastStatusUpdateTime&&JSON.stringify(status)===this._lastStatusUpdate&&Date.now()-this._lastStatusUpdateTime.getTime()<this._coalesceStatusUpdatesInMillis;if(this._onPlaybackStatusUpdate!=null&&!shouldDismissBasedOnCoalescing){this._onPlaybackStatusUpdate(status);this._lastStatusUpdateTime=new Date();this._lastStatusUpdate=JSON.stringify(status);}}},{key:\"_performOperationAndHandleStatusAsync\",value:function _performOperationAndHandleStatusAsync(operation){var _status;return _regeneratorRuntime.async(function _performOperationAndHandleStatusAsync$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:throwIfAudioIsDisabled();if(!this._loaded){_context2.next=9;break;}_context2.next=4;return _regeneratorRuntime.awrap(operation());case 4:_status=_context2.sent;this._callOnPlaybackStatusUpdateForNewStatus(_status);return _context2.abrupt(\"return\",_status);case 9:throw new Error('Cannot complete operation because sound is not loaded.');case 10:case\"end\":return _context2.stop();}}},null,this,null,Promise);}},{key:\"_subscribeToNativeEvents\",value:function _subscribeToNativeEvents(){if(this._loaded){this._subscriptions.push(this._eventEmitter.addListener('didUpdatePlaybackStatus',this._internalStatusUpdateCallback));this._subscriptions.push(this._eventEmitter.addListener('ExponentAV.onError',this._internalErrorCallback));}}},{key:\"_clearSubscriptions\",value:function _clearSubscriptions(){this._subscriptions.forEach(function(e){return e.remove();});this._subscriptions=[];}},{key:\"setOnPlaybackStatusUpdate\",value:function setOnPlaybackStatusUpdate(onPlaybackStatusUpdate){this._onPlaybackStatusUpdate=onPlaybackStatusUpdate;this.getStatusAsync();}},{key:\"loadAsync\",value:function loadAsync(source){var _this2=this;var initialStatus,downloadFirst,_await$getNativeSourc,nativeSource,fullInitialStatus,_args3=arguments;return _regeneratorRuntime.async(function loadAsync$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:initialStatus=_args3.length>1&&_args3[1]!==undefined?_args3[1]:{};downloadFirst=_args3.length>2&&_args3[2]!==undefined?_args3[2]:true;throwIfAudioIsDisabled();if(!this._loading){_context3.next=5;break;}throw new Error('The Sound is already loading.');case 5:if(this._loaded){_context3.next=15;break;}this._loading=true;_context3.next=9;return _regeneratorRuntime.awrap(getNativeSourceAndFullInitialStatusForLoadAsync(source,initialStatus,downloadFirst));case 9:_await$getNativeSourc=_context3.sent;nativeSource=_await$getNativeSourc.nativeSource;fullInitialStatus=_await$getNativeSourc.fullInitialStatus;return _context3.abrupt(\"return\",new Promise(function(resolve,reject){var loadSuccess=function loadSuccess(result){var _result=_slicedToArray(result,2),key=_result[0],status=_result[1];_this2._key=key;_this2._loaded=true;_this2._loading=false;_this2._subscribeToNativeEvents();_this2._callOnPlaybackStatusUpdateForNewStatus(status);resolve(status);};var loadError=function loadError(error){_this2._loading=false;reject(error);};ExponentAV.loadForSound(nativeSource,fullInitialStatus).then(loadSuccess).catch(loadError);}));case 15:throw new Error('The Sound is already loaded.');case 16:case\"end\":return _context3.stop();}}},null,this,null,Promise);}},{key:\"unloadAsync\",value:function unloadAsync(){var key,_status2;return _regeneratorRuntime.async(function unloadAsync$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(!this._loaded){_context4.next=12;break;}this._loaded=false;key=this._key;this._key=null;_context4.next=6;return _regeneratorRuntime.awrap(ExponentAV.unloadForSound(key));case 6:_status2=_context4.sent;this._callOnPlaybackStatusUpdateForNewStatus(_status2);this._clearSubscriptions();return _context4.abrupt(\"return\",_status2);case 12:return _context4.abrupt(\"return\",this.getStatusAsync());case 13:case\"end\":return _context4.stop();}}},null,this,null,Promise);}},{key:\"setStatusAsync\",value:function setStatusAsync(status){var _this3=this;return _regeneratorRuntime.async(function setStatusAsync$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:assertStatusValuesInBounds(status);return _context5.abrupt(\"return\",this._performOperationAndHandleStatusAsync(function(){return ExponentAV.setStatusForSound(_this3._key,status);}));case 2:case\"end\":return _context5.stop();}}},null,this,null,Promise);}},{key:\"replayAsync\",value:function replayAsync(){var _this4=this;var status,_args6=arguments;return _regeneratorRuntime.async(function replayAsync$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:status=_args6.length>0&&_args6[0]!==undefined?_args6[0]:{};if(!(status.positionMillis&&status.positionMillis!==0)){_context6.next=3;break;}throw new Error('Requested position after replay has to be 0.');case 3:return _context6.abrupt(\"return\",this._performOperationAndHandleStatusAsync(function(){return ExponentAV.replaySound(_this4._key,_objectSpread(_objectSpread({},status),{},{positionMillis:0,shouldPlay:true}));}));case 4:case\"end\":return _context6.stop();}}},null,this,null,Promise);}}]);return Sound;}();Sound.create=function _callee2(source){var initialStatus,onPlaybackStatusUpdate,downloadFirst,_args7=arguments;return _regeneratorRuntime.async(function _callee2$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:initialStatus=_args7.length>1&&_args7[1]!==undefined?_args7[1]:{};onPlaybackStatusUpdate=_args7.length>2&&_args7[2]!==undefined?_args7[2]:null;downloadFirst=_args7.length>3&&_args7[3]!==undefined?_args7[3]:true;console.warn(\"Sound.create is deprecated in favor of Sound.createAsync with the same API except for the new method name\");return _context7.abrupt(\"return\",Sound.createAsync(source,initialStatus,onPlaybackStatusUpdate,downloadFirst));case 5:case\"end\":return _context7.stop();}}},null,null,null,Promise);};Sound.createAsync=function _callee3(source){var initialStatus,onPlaybackStatusUpdate,downloadFirst,sound,status,_args8=arguments;return _regeneratorRuntime.async(function _callee3$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:initialStatus=_args8.length>1&&_args8[1]!==undefined?_args8[1]:{};onPlaybackStatusUpdate=_args8.length>2&&_args8[2]!==undefined?_args8[2]:null;downloadFirst=_args8.length>3&&_args8[3]!==undefined?_args8[3]:true;sound=new Sound();sound.setOnPlaybackStatusUpdate(onPlaybackStatusUpdate);_context8.next=7;return _regeneratorRuntime.awrap(sound.loadAsync(source,initialStatus,downloadFirst));case 7:status=_context8.sent;return _context8.abrupt(\"return\",{sound:sound,status:status});case 9:case\"end\":return _context8.stop();}}},null,null,null,Promise);};_extends(Sound.prototype,PlaybackMixin);","map":null,"metadata":{},"sourceType":"module"}