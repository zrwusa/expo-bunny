{"ast":null,"code":"var _jsxFileName=\"/Users/revone/projects/expo-react-bunny/src/screens/DemoChat/Home/ChatHome.tsx\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";import React,{useEffect}from'react';import{Text}from\"../../../components/UI\";import Dimensions from\"react-native-web/dist/exports/Dimensions\";import FlatList from\"react-native-web/dist/exports/FlatList\";import SafeAreaView from\"react-native-web/dist/exports/SafeAreaView\";import View from\"react-native-web/dist/exports/View\";import{useSelector}from'react-redux';import{Col,Row}from\"../../../containers\";import{makeStyles}from\"./styles\";import{useBunnyKit}from\"../../../hooks/bunny-kit\";import{isLoaded,useFirebaseConnect,useFirestore,useFirestoreConnect}from'react-redux-firebase';import{Avatar,Divider,InlineJump,Preparing}from\"../../../components\";import dayJS from'dayjs';import isToday from'dayjs/plugin/isToday';import{useSafeAreaInsets}from'react-native-safe-area-context';import{firestoreTimestampToDate}from\"../../../utils\";dayJS.extend(isToday);export function ChatHomeScreen(_ref){var _this=this;var route=_ref.route,navigation=_ref.navigation;var _useBunnyKit=useBunnyKit(),sizeLabor=_useBunnyKit.sizeLabor,themeLabor=_useBunnyKit.themeLabor,user=_useBunnyKit.user,wp=_useBunnyKit.wp;var styles=makeStyles(sizeLabor,themeLabor);var firebaseUser=user==null?void 0:user.firebaseUser;var userId='';if(firebaseUser){userId=firebaseUser.uid;}useFirebaseConnect([{path:'chatRooms',queryParams:[]}]);useFirestoreConnect([{collection:'conversations',where:[['users','array-contains',userId]]}]);useFirestoreConnect([{collection:'users'}]);var conversations=useSelector(function(state){return state.firestoreState.ordered.conversations;});var firestore=useFirestore();useEffect(function(){getCurrentUserConversationsMessages().then();},[conversations]);var getCurrentUserConversationsMessages=function getCurrentUserConversationsMessages(){var whereConversationIds;return _regeneratorRuntime.async(function getCurrentUserConversationsMessages$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(conversations&&conversations.length>0)){_context.next=4;break;}whereConversationIds=conversations.map(function(item){return item.id;});_context.next=4;return _regeneratorRuntime.awrap(firestore.get({collection:'chatMessages',orderBy:['createdAt','desc'],storeAs:'currentUserConversationsMessages'}));case 4:case\"end\":return _context.stop();}}},null,null,null,Promise);};var insets=useSafeAreaInsets();var users=useSelector(function(state){return state.firestoreState.ordered.users;});var currentUserConversationsMessages=useSelector(function(state){return state.firestoreState.ordered.currentUserConversationsMessages;});var handleRoomPress=function handleRoomPress(key){};var renderAvatar=function renderAvatar(conversation){switch(conversation.type){case'GROUP':return React.createElement(Avatar,{size:\"l\",isBorder:false,source:{uri:conversation.avatar},__self:_this,__source:{fileName:_jsxFileName,lineNumber:93,columnNumber:24}});case'COUPLE':var otherUsersInConversation=users==null?void 0:users.filter(function(user){return conversation.users.includes(user.uid)&&user.uid!==userId;});return otherUsersInConversation&&otherUsersInConversation[0]&&otherUsersInConversation[0].photoURL?React.createElement(Avatar,{size:\"l\",isBorder:false,source:{uri:otherUsersInConversation[0].photoURL},__self:_this,__source:{fileName:_jsxFileName,lineNumber:99,columnNumber:23}}):null;}};var renderLatestMessage=function renderLatestMessage(conversation){var latestMessages=currentUserConversationsMessages==null?void 0:currentUserConversationsMessages.filter(function(item){return item.conversationId===conversation.id;});var latestMessage=latestMessages==null?void 0:latestMessages[0];var tipText='';var tipTime='';if(latestMessage){var createdAtTimestamp=firestoreTimestampToDate(latestMessage.createdAt);var date=dayJS(createdAtTimestamp);var now=new Date();var _isToday=date.isToday();var isSameWeek=date.isSame(now,'week');tipTime=_isToday?date.format('LT'):isSameWeek?date.format('ddd').toString():date.format('MM/DD/YY');switch(latestMessage.type){case'MESSAGE':tipText=latestMessage.text;break;case'IMAGE':tipText='Image Message';break;case'STICKER_GIF':tipText='Sticker Message';break;case'AUDIO':tipText='Voice Message';break;case'VIDEO':tipText='Video Message';break;default:break;}}return React.createElement(React.Fragment,null,React.createElement(Row,{style:styles.timePanel,__self:_this,__source:{fileName:_jsxFileName,lineNumber:143,columnNumber:13}},React.createElement(Text,{__self:_this,__source:{fileName:_jsxFileName,lineNumber:144,columnNumber:17}},conversation.name),React.createElement(Text,{style:styles.time,__self:_this,__source:{fileName:_jsxFileName,lineNumber:145,columnNumber:17}},tipTime)),React.createElement(Row,{style:styles.tipPanel,__self:_this,__source:{fileName:_jsxFileName,lineNumber:147,columnNumber:13}},React.createElement(Text,{style:styles.tip,__self:_this,__source:{fileName:_jsxFileName,lineNumber:148,columnNumber:17}},tipText)));};var _renderItem=function renderItem(conversation){return React.createElement(View,{style:styles.conversation,__self:_this,__source:{fileName:_jsxFileName,lineNumber:155,columnNumber:13}},React.createElement(InlineJump,{type:\"LINK\",to:\"/demo-chat/chat-rooms/\"+conversation.id,__self:_this,__source:{fileName:_jsxFileName,lineNumber:156,columnNumber:17}},React.createElement(Row,{paddingVertical:\"m\",__self:_this,__source:{fileName:_jsxFileName,lineNumber:157,columnNumber:21}},React.createElement(Col,{size:1,__self:_this,__source:{fileName:_jsxFileName,lineNumber:158,columnNumber:25}},renderAvatar(conversation)),React.createElement(Col,{size:5,style:styles.latestMessage,__self:_this,__source:{fileName:_jsxFileName,lineNumber:163,columnNumber:25}},renderLatestMessage(conversation)))),React.createElement(Divider,{__self:_this,__source:{fileName:_jsxFileName,lineNumber:170,columnNumber:17}}));};var webFlatListHeight=Dimensions.get('window').height-insets.top-insets.bottom-wp(46);return React.createElement(SafeAreaView,{style:{flex:1},__self:this,__source:{fileName:_jsxFileName,lineNumber:181,columnNumber:9}},isLoaded(conversations)?React.createElement(FlatList,{style:{height:webFlatListHeight},data:conversations,renderItem:function renderItem(_ref2){var item=_ref2.item;return _renderItem(item);},keyExtractor:function keyExtractor(item){return item.id;},__self:this,__source:{fileName:_jsxFileName,lineNumber:184,columnNumber:23}}):React.createElement(Preparing,{__self:this,__source:{fileName:_jsxFileName,lineNumber:192,columnNumber:23}}));}","map":{"version":3,"sources":["/Users/revone/projects/expo-react-bunny/src/screens/DemoChat/Home/ChatHome.tsx"],"names":["dayJS","route","navigation","sizeLabor","themeLabor","user","wp","useBunnyKit","styles","makeStyles","firebaseUser","userId","useFirebaseConnect","path","queryParams","useFirestoreConnect","collection","where","conversations","useSelector","state","firestore","useFirestore","useEffect","getCurrentUserConversationsMessages","whereConversationIds","item","orderBy","storeAs","insets","useSafeAreaInsets","users","currentUserConversationsMessages","handleRoomPress","renderAvatar","conversation","uri","avatar","otherUsersInConversation","photoURL","renderLatestMessage","latestMessages","latestMessage","tipText","tipTime","createdAtTimestamp","firestoreTimestampToDate","date","now","isToday","isSameWeek","renderItem","webFlatListHeight","Dimensions","flex","height"],"mappings":"8JAAA,MAAA,CAAA,KAAA,EAAA,SAAA,KAAA,OAAA,CACA,OAAA,IAAA,8B,wPAKA,OAAA,WAAA,KAAA,aAAA,CACA,OAAA,GAAA,CAAA,GAAA,2BACA,OAAA,UAAA,gBACA,OAAA,WAAA,gCACA,OAAA,QAAA,CAAA,kBAAA,CAAA,YAAA,CAAA,mBAAA,KAAA,sBAAA,CAEA,OAAA,MAAA,CAAA,OAAA,CAAA,UAAA,CAAA,SAAA,2BACA,MAAA,CAAA,KAAA,KAAA,OAAA,CACA,MAAA,CAAA,OAAA,KAAA,sBAAA,CACA,OAAA,iBAAA,KAAA,gCAAA,CACA,OAAA,wBAAA,sBAEAA,KAAK,CAALA,MAAAA,CAAAA,OAAAA,EAUA,MAAO,SAAA,CAAA,cAAA,CAAA,IAAA,CAA4D,CAAA,GAAA,CAAA,KAAA,CAAA,IAAA,CAAA,GAAnCC,CAAAA,KAAmC,CAAA,IAAA,CAAnCA,KAAmC,CAA5BC,UAA4B,CAAA,IAAA,CAA5BA,UAA4B,CAC/D,GAAA,CAAA,YAAA,CAA0CK,WAA1C,EAAA,CAAOJ,SAAP,CAAA,YAAA,CAAA,SAAA,CAAkBC,UAAlB,CAAA,YAAA,CAAA,UAAA,CAA8BC,IAA9B,CAAA,YAAA,CAAA,IAAA,CAAoCC,EAApC,CAAA,YAAA,CAAA,EAAA,CACA,GAAME,CAAAA,MAAM,CAAGC,UAAU,CAAA,SAAA,CAAzB,UAAyB,CAAzB,CAEA,GAAMC,CAAAA,YAAY,CAAGL,IAAH,EAAA,IAAGA,CAAH,IAAA,EAAGA,CAAAA,IAAI,CAAzB,YAAA,CAEA,GAAIM,CAAAA,MAAM,CAAV,EAAA,CACA,GAAA,YAAA,CAAkB,CACdA,MAAM,CAAGD,YAAY,CAArBC,GAAAA,CACH,CAEDC,kBAAkB,CAAC,CAAC,CAACC,IAAI,CAAL,WAAA,CAAoBC,WAAW,CAAE,EAAjC,CAAD,CAAD,CAAlBF,CAEAG,mBAAmB,CAAC,CAAC,CACjBC,UAAU,CADO,eAAA,CACYC,KAAK,CAAE,CAChC,CAAA,OAAA,CAAA,gBAAA,CADgC,MAChC,CADgC,CADnB,CAAD,CAAD,CAAnBF,CAMAA,mBAAmB,CAAC,CAAC,CAACC,UAAU,CAAE,OAAb,CAAD,CAAD,CAAnBD,CAEA,GAAMG,CAAAA,aAAa,CAAGC,WAAW,CAAC,SAAA,KAAA,CAAA,CAAA,MAAsBC,CAAAA,KAAK,CAALA,cAAAA,CAAAA,OAAAA,CAAtB,aAAA,CAAlC,CAAiC,CAAjC,CACA,GAAMC,CAAAA,SAAS,CAAGC,YAAlB,EAAA,CAEAC,SAAS,CAAC,UAAM,CACZC,mCAAmC,GAAnCA,IAAAA,GADK,CAAA,CAEN,CAFHD,aAEG,CAFM,CAATA,CAIA,GAAMC,CAAAA,mCAAmC,CAAG,QAAtCA,CAAAA,mCAAsC,EAAA,CAAA,GAAA,CAAA,oBAAA,CAAA,MAAA,CAAA,mBAAA,CAAA,KAAA,CAAA,QAAA,CAAA,oCAAA,CAAA,QAAA,CAAA,CAAA,MAAA,CAAA,CAAA,CAAA,OAAA,QAAA,CAAA,IAAA,CAAA,QAAA,CAAA,IAAA,EAAA,IAAA,EAAA,CAAA,GAAA,EACpCN,aAAa,EAAKA,aAAa,CAAbA,MAAAA,CADkB,CAAA,CAAA,CAAA,CAAA,QAAA,CAAA,IAAA,CAAA,CAAA,CAAA,MAAA,CAE9BO,oBAF8B,CAEP,aAAa,CAAb,GAAA,CAAkB,SAAA,IAAA,CAAI,CAAA,MAAIC,CAAAA,IAAI,CAAR,EAAA,CAFf,CAEP,CAAvBD,CAF8B,QAAA,CAAA,IAAA,CAAA,CAAA,CAAA,MAAA,CAAA,mBAAA,CAAA,KAAA,CAI9B,SAAS,CAAT,GAAA,CACF,CACIT,UAAU,CADd,cAAA,CAEIW,OAAO,CAAE,CAAA,WAAA,CAFb,MAEa,CAFb,CAMIC,OAAO,CAAE,kCANb,CADE,CAJ8B,CAAA,CAAA,IAAA,EAAA,CAAA,IAAA,KAAA,CAAA,MAAA,CAAA,QAAA,CAAA,IAAA,EAAA,CAAA,CAAA,CAAA,CAAA,CAAA,IAAA,CAAA,IAAA,CAAA,IAAA,CAAA,OAAA,CAAA,CAA5C,CAAA,CAiBA,GAAMC,CAAAA,MAAM,CAAGC,iBAAf,EAAA,CAEA,GAAMC,CAAAA,KAAK,CAAGZ,WAAW,CAAC,SAAA,KAAA,CAAA,CAAA,MAAsBC,CAAAA,KAAK,CAALA,cAAAA,CAAAA,OAAAA,CAAtB,KAAA,CAA1B,CAAyB,CAAzB,CACA,GAAMY,CAAAA,gCAAgC,CAAGb,WAAW,CAAC,SAAA,KAAA,CAAA,CAAA,MAAsBC,CAAAA,KAAK,CAALA,cAAAA,CAAAA,OAAAA,CAAtB,gCAAA,CAArD,CAAoD,CAApD,CAGA,GAAMa,CAAAA,eAAe,CAAG,QAAlBA,CAAAA,eAAkB,CAAA,GAAA,CAAiB,CAAzC,CAAA,CAUA,GAAMC,CAAAA,YAAY,CAAG,QAAfA,CAAAA,YAAe,CAAA,YAAA,CAAgC,CACjD,OAAQC,YAAY,CAApB,IAAA,EACI,IAAA,OAAA,CACI,MAAO,CAAA,KAAA,CAAA,aAAA,CAAA,MAAA,CAAA,CAAQ,IAAI,CAAZ,GAAA,CAAiB,QAAQ,CAAzB,KAAA,CAAkC,MAAM,CAAE,CAACC,GAAG,CAAED,YAAY,CAACE,MAAnB,CAA1C,CAAA,MAAA,CAAA,KAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,EAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CAAP,CACJ,IAAA,QAAA,CACI,GAAMC,CAAAA,wBAAwB,CAAG,KAAH,EAAA,IAAG,CAAH,IAAA,EAAG,CAAA,KAAK,CAAL,MAAA,CAAc,SAAA,IAAA,CAAU,CACrD,MAAOH,CAAAA,YAAY,CAAZA,KAAAA,CAAAA,QAAAA,CAA4B9B,IAAI,CAAhC8B,GAAAA,GAAyC9B,IAAI,CAAJA,GAAAA,GAAhD,MAAA,CADJ,CAAiC,CAAjC,CAGA,MAAQiC,CAAAA,wBAAwB,EAAIA,wBAAwB,CAApDA,CAAoD,CAApDA,EAA2DA,wBAAwB,CAAxBA,CAAwB,CAAxBA,CAA5D,QAACA,CACF,KAAA,CAAA,aAAA,CAAA,MAAA,CAAA,CAAQ,IAAI,CAAZ,GAAA,CAAiB,QAAQ,CAAzB,KAAA,CAAkC,MAAM,CAAE,CAACF,GAAG,CAAEE,wBAAwB,CAAxBA,CAAwB,CAAxBA,CAA4BC,QAAlC,CAA1C,CAAA,MAAA,CAAA,KAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,EAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CADED,CAAR,IAAA,CAPR,CADJ,CAAA,CAeA,GAAME,CAAAA,mBAAmB,CAAG,QAAtBA,CAAAA,mBAAsB,CAAA,YAAA,CAA+D,CACvF,GAAMC,CAAAA,cAAc,CAAG,gCAAH,EAAA,IAAG,CAAH,IAAA,EAAG,CAAA,gCAAgC,CAAhC,MAAA,CAAyC,SAAA,IAAA,CAAU,CACtE,MAAQf,CAAAA,IAAI,CAAJA,cAAAA,GAAwBS,YAAY,CAA5C,EAAA,CADJ,CAAuB,CAAvB,CAGA,GAAMO,CAAAA,aAAa,CAAGD,cAAH,EAAA,IAAGA,CAAH,IAAA,EAAGA,CAAAA,cAAc,CAApC,CAAoC,CAApC,CACA,GAAIE,CAAAA,OAAO,CAAX,EAAA,CACA,GAAIC,CAAAA,OAAO,CAAX,EAAA,CAEA,GAAA,aAAA,CAAmB,CACf,GAAMC,CAAAA,kBAAkB,CAAGC,wBAAwB,CAACJ,aAAa,CAAjE,SAAmD,CAAnD,CACA,GAAMK,CAAAA,IAAI,CAAG/C,KAAK,CAAlB,kBAAkB,CAAlB,CACA,GAAMgD,CAAAA,GAAG,CAAG,GAAZ,CAAA,IAAY,EAAZ,CACA,GAAMC,CAAAA,QAAO,CAAGF,IAAI,CAApB,OAAgBA,EAAhB,CACA,GAAMG,CAAAA,UAAU,CAAGH,IAAI,CAAJA,MAAAA,CAAAA,GAAAA,CAAnB,MAAmBA,CAAnB,CACAH,OAAO,CAAGK,QAAO,CAAGF,IAAI,CAAJA,MAAAA,CAAH,IAAGA,CAAH,CAAuBG,UAAU,CAAGH,IAAI,CAAJA,MAAAA,CAAAA,KAAAA,EAAH,QAAGA,EAAH,CAAmCA,IAAI,CAAJA,MAAAA,CAArFH,UAAqFG,CAArFH,CACA,OAAQF,aAAa,CAArB,IAAA,EACI,IAAA,SAAA,CACIC,OAAO,CAAGD,aAAa,CAAvBC,IAAAA,CACA,MACJ,IAAA,OAAA,CACIA,OAAO,CAAPA,eAAAA,CACA,MACJ,IAAA,aAAA,CACIA,OAAO,CAAPA,iBAAAA,CACA,MACJ,IAAA,OAAA,CACIA,OAAO,CAAPA,eAAAA,CACA,MACJ,IAAA,OAAA,CACIA,OAAO,CAAPA,eAAAA,CACA,MACJ,QAEI,MAlBR,CAoBH,CAED,MAAO,CAAA,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,QAAA,CAAA,IAAA,CACH,KAAA,CAAA,aAAA,CAAA,GAAA,CAAA,CAAK,KAAK,CAAEnC,MAAM,CAAlB,SAAA,CAAA,MAAA,CAAA,KAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CACI,KAAA,CAAA,aAAA,CAAA,IAAA,CAAA,CAAA,MAAA,CAAA,KAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CAAO2B,YAAY,CADvB,IACI,CADJ,CAEI,KAAA,CAAA,aAAA,CAAA,IAAA,CAAA,CAAM,KAAK,CAAE3B,MAAM,CAAnB,IAAA,CAAA,MAAA,CAAA,KAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CAHD,OAGC,CAFJ,CADG,CAKH,KAAA,CAAA,aAAA,CAAA,GAAA,CAAA,CAAK,KAAK,CAAEA,MAAM,CAAlB,QAAA,CAAA,MAAA,CAAA,KAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CACI,KAAA,CAAA,aAAA,CAAA,IAAA,CAAA,CAAM,KAAK,CAAEA,MAAM,CAAnB,GAAA,CAAA,MAAA,CAAA,KAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CANR,OAMQ,CADJ,CALG,CAAP,CArCJ,CAAA,CAgDA,GAAM2C,CAAAA,WAAU,CAAG,QAAbA,CAAAA,UAAa,CAAA,YAAA,CAA+D,CAC9E,MACI,CAAA,KAAA,CAAA,aAAA,CAAA,IAAA,CAAA,CAAM,KAAK,CAAE3C,MAAM,CAAnB,YAAA,CAAA,MAAA,CAAA,KAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CACI,KAAA,CAAA,aAAA,CAAA,UAAA,CAAA,CAAY,IAAI,CAAhB,MAAA,CAAwB,EAAE,CAAA,yBAA2B2B,YAAY,CAAjE,EAAA,CAAA,MAAA,CAAA,KAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CACI,KAAA,CAAA,aAAA,CAAA,GAAA,CAAA,CAAK,eAAe,CAApB,GAAA,CAAA,MAAA,CAAA,KAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CACI,KAAA,CAAA,aAAA,CAAA,GAAA,CAAA,CAAK,IAAI,CAAT,CAAA,CAAA,MAAA,CAAA,KAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CAEQD,YAAY,CAHxB,YAGwB,CAFpB,CADJ,CAMI,KAAA,CAAA,aAAA,CAAA,GAAA,CAAA,CAAK,IAAI,CAAT,CAAA,CAAc,KAAK,CAAE1B,MAAM,CAA3B,aAAA,CAAA,MAAA,CAAA,KAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CAEQgC,mBAAmB,CAVvC,YAUuC,CAF3B,CANJ,CADJ,CADJ,CAeI,KAAA,CAAA,aAAA,CAAA,OAAA,CAAA,CAAA,MAAA,CAAA,KAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CAfJ,CADJ,CADJ,CAAA,CAyBA,GAAMY,CAAAA,iBAAiB,CAAGC,UAAU,CAAVA,GAAAA,CAAAA,QAAAA,EAAAA,MAAAA,CAAkCxB,MAAM,CAAxCwB,GAAAA,CAA+CxB,MAAM,CAArDwB,MAAAA,CAA+D/C,EAAE,CAA3F,EAA2F,CAA3F,CAEA,MACI,CAAA,KAAA,CAAA,aAAA,CAAA,YAAA,CAAA,CAAc,KAAK,CAAE,CAACgD,IAAI,CAAE,CAAP,CAArB,CAAA,MAAA,CAAA,IAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,CAAA,CAAA,CAAA,CAEQ,QAAQ,CAAR,aAAQ,CAAR,CACM,KAAA,CAAA,aAAA,CAAA,QAAA,CAAA,CACE,KAAK,CAAE,CAACC,MAAM,CAAEH,iBAAT,CADT,CAEE,IAAI,CAFN,aAAA,CAGE,UAAU,CAAE,QAAA,CAAA,UAAA,CAAA,KAAA,CAAY,CAAA,GAAV1B,CAAAA,IAAU,CAAA,KAAA,CAAVA,IAAU,CACpB,MAAOyB,CAAAA,WAAU,CAAjB,IAAiB,CAAjB,CAJN,CAAA,CAME,YAAY,CAAE,QAAA,CAAA,YAAA,CAAA,IAAA,CAAA,CAAA,MAAUzB,CAAAA,IAAI,CAAd,EAAA,CANhB,CAAA,CAAA,MAAA,CAAA,IAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CADN,CASM,KAAA,CAAA,aAAA,CAAA,SAAA,CAAA,CAAA,MAAA,CAAA,IAAA,CAAA,QAAA,CAAA,CAAA,QAAA,CAAA,YAAA,CAAA,UAAA,CAAA,GAAA,CAAA,YAAA,CAAA,EAAA,CAAA,CAAA,CAXd,CADJ,CAgBH","sourcesContent":["import React, {useEffect} from 'react';\nimport {Text} from '../../../components/UI';\nimport {Dimensions, FlatList, SafeAreaView, View} from 'react-native';\nimport {RouteProp} from '@react-navigation/native';\nimport {Conversation, DemoChatStackParam, RootStackParam, RootState} from '../../../types';\nimport {StackNavigationProp} from '@react-navigation/stack';\nimport {useSelector} from 'react-redux';\nimport {Col, Row} from '../../../containers';\nimport {makeStyles} from './styles';\nimport {useBunnyKit} from '../../../hooks/bunny-kit';\nimport {isLoaded, useFirebaseConnect, useFirestore, useFirestoreConnect} from 'react-redux-firebase';\nimport {FirestoreReducer} from 'redux-firestore';\nimport {Avatar, Divider, InlineJump, Preparing} from '../../../components';\nimport dayJS from 'dayjs';\nimport isToday from 'dayjs/plugin/isToday';\nimport {useSafeAreaInsets} from 'react-native-safe-area-context';\nimport {firestoreTimestampToDate} from '../../../utils';\n\ndayJS.extend(isToday);\n\ntype ChatHomeRouteProp = RouteProp<DemoChatStackParam, 'ChatHome'>;\ntype ChatHomeNavigationProp = StackNavigationProp<RootStackParam, 'DemoChat'>;\n\nexport interface ChatHomeProps {\n    route: ChatHomeRouteProp,\n    navigation: ChatHomeNavigationProp\n}\n\nexport function ChatHomeScreen({route, navigation}: ChatHomeProps) {\n    const {sizeLabor, themeLabor, user, wp} = useBunnyKit();\n    const styles = makeStyles(sizeLabor, themeLabor);\n\n    const firebaseUser = user?.firebaseUser;\n\n    let userId = '';\n    if (firebaseUser) {\n        userId = firebaseUser.uid;\n    }\n\n    useFirebaseConnect([{path: 'chatRooms', queryParams: []}]);\n\n    useFirestoreConnect([{\n        collection: 'conversations', where: [\n            ['users', 'array-contains', userId],\n        ],\n    }]);\n\n    useFirestoreConnect([{collection: 'users',}]);\n\n    const conversations = useSelector((state: RootState) => state.firestoreState.ordered.conversations);\n    const firestore = useFirestore();\n\n    useEffect(() => {\n        getCurrentUserConversationsMessages().then();\n    }, [conversations]);\n\n    const getCurrentUserConversationsMessages = async () => {\n        if (conversations && (conversations.length > 0)) {\n            const whereConversationIds = conversations.map(item => item.id);\n            // TODO Invalid Query. 'in' filters support a maximum of 10 elements in the value array.\n            await firestore.get(\n                {\n                    collection: 'chatMessages',\n                    orderBy: ['createdAt', 'desc'],\n                    // where: [\n                    //     ['conversationId', 'in', whereConversationIds],\n                    // ],\n                    storeAs: 'currentUserConversationsMessages'\n                }\n            );\n        }\n    };\n\n    const insets = useSafeAreaInsets();\n\n    const users = useSelector((state: RootState) => state.firestoreState.ordered.users);\n    const currentUserConversationsMessages = useSelector((state: RootState) => state.firestoreState.ordered.currentUserConversationsMessages);\n\n    // TODO On web platform, when jumping from one sub-navigation to another sub-navigation, the back button does not work\n    const handleRoomPress = (key: string) => {\n        // navigation.navigate('DemoChat', {\n        //     screen: 'ChatRoom',\n        //     params: {\n        //         conversationId: key,\n        //     },\n        // })\n        // navigation.navigate('ChatRoom', {conversationId: key})\n    };\n\n    const renderAvatar = (conversation: Conversation) => {\n        switch (conversation.type) {\n            case 'GROUP':\n                return <Avatar size=\"l\" isBorder={false} source={{uri: conversation.avatar}}/>;\n            case 'COUPLE':\n                const otherUsersInConversation = users?.filter((user) => {\n                    return conversation.users.includes(user.uid) && user.uid !== userId;\n                });\n                return (otherUsersInConversation && otherUsersInConversation[0] && otherUsersInConversation[0].photoURL)\n                    ? <Avatar size=\"l\" isBorder={false} source={{uri: otherUsersInConversation[0].photoURL}}/>\n                    : null;\n\n        }\n    };\n\n    const renderLatestMessage = (conversation: FirestoreReducer.EntityWithId<Conversation>) => {\n        const latestMessages = currentUserConversationsMessages?.filter((item) => {\n            return (item.conversationId === conversation.id);\n        });\n        const latestMessage = latestMessages?.[0];\n        let tipText = '';\n        let tipTime = '';\n\n        if (latestMessage) {\n            const createdAtTimestamp = firestoreTimestampToDate(latestMessage.createdAt);\n            const date = dayJS(createdAtTimestamp);\n            const now = new Date();\n            const isToday = date.isToday();\n            const isSameWeek = date.isSame(now, 'week');\n            tipTime = isToday ? date.format('LT') : isSameWeek ? date.format('ddd').toString() : date.format('MM/DD/YY');\n            switch (latestMessage.type) {\n                case 'MESSAGE':\n                    tipText = latestMessage.text;\n                    break;\n                case 'IMAGE':\n                    tipText = 'Image Message';\n                    break;\n                case 'STICKER_GIF':\n                    tipText = 'Sticker Message';\n                    break;\n                case 'AUDIO':\n                    tipText = 'Voice Message';\n                    break;\n                case 'VIDEO':\n                    tipText = 'Video Message';\n                    break;\n                default:\n\n                    break;\n            }\n        }\n\n        return <>\n            <Row style={styles.timePanel}>\n                <Text>{conversation.name}</Text>\n                <Text style={styles.time}>{tipTime}</Text>\n            </Row>\n            <Row style={styles.tipPanel}>\n                <Text style={styles.tip}>{tipText}</Text>\n            </Row>\n        </>;\n    };\n\n    const renderItem = (conversation: FirestoreReducer.EntityWithId<Conversation>) => {\n        return (\n            <View style={styles.conversation}>\n                <InlineJump type=\"LINK\" to={`/demo-chat/chat-rooms/${conversation.id}`}>\n                    <Row paddingVertical=\"m\">\n                        <Col size={1}>\n                            {\n                                renderAvatar(conversation)\n                            }\n                        </Col>\n                        <Col size={5} style={styles.latestMessage}>\n                            {\n                                renderLatestMessage(conversation)\n                            }\n                        </Col>\n                    </Row>\n                </InlineJump>\n                <Divider/>\n            </View>\n\n        );\n    };\n\n    // React Navigation bug,when nested navigators and headerShown = false,\n    // the FlatList height not limited,as such the scrolling does't work\n    const webFlatListHeight = Dimensions.get('window').height - insets.top - insets.bottom - wp(46);\n\n    return (\n        <SafeAreaView style={{flex: 1}}>\n            {\n                isLoaded(conversations)\n                    ? <FlatList\n                        style={{height: webFlatListHeight}}\n                        data={conversations}\n                        renderItem={({item}) => {\n                            return renderItem(item);\n                        }}\n                        keyExtractor={(item) => item.id as any}\n                    />\n                    : <Preparing/>\n            }\n        </SafeAreaView>\n    );\n}\n"]},"metadata":{},"sourceType":"module"}