{"ast":null,"code":"\"use strict\";var _interopRequireDefault2=require(\"@babel/runtime/helpers/interopRequireDefault\");var _slicedToArray2=_interopRequireDefault2(require(\"@babel/runtime/helpers/slicedToArray\"));var _classCallCheck2=_interopRequireDefault2(require(\"@babel/runtime/helpers/classCallCheck\"));var _createClass2=_interopRequireDefault2(require(\"@babel/runtime/helpers/createClass\"));var _regenerator=_interopRequireDefault2(require(\"@babel/runtime/regenerator\"));exports.__esModule=true;exports.default=void 0;var _escapeStringRegexp=_interopRequireDefault(require(\"next/dist/compiled/escape-string-regexp\"));var _nodeHtmlParser=require(\"node-html-parser\");var _constants=require(\"./constants\");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var MAXIMUM_IMAGE_PRELOADS=2;var IMAGE_PRELOAD_SIZE_THRESHOLD=2500;var middlewareRegistry=[];function registerPostProcessor(name,middleware,condition){middlewareRegistry.push({name:name,middleware:middleware,condition:condition||null});}function processHTML(html,data,options){var root,document,callMiddleWare,i,middleware;return _regenerator.default.async(function processHTML$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:callMiddleWare=function _callMiddleWare(middleware){var inspectData;return _regenerator.default.async(function callMiddleWare$(_context){while(1){switch(_context.prev=_context.next){case 0:inspectData=middleware.inspect(root,data);_context.next=3;return _regenerator.default.awrap(middleware.mutate(document,inspectData,data));case 3:document=_context.sent;return _context.abrupt(\"return\");case 5:case\"end\":return _context.stop();}}},null,null,null,Promise);};if(middlewareRegistry[0]){_context2.next=3;break;}return _context2.abrupt(\"return\",html);case 3:root=(0,_nodeHtmlParser.parse)(html);document=html;i=0;case 6:if(!(i<middlewareRegistry.length)){_context2.next=14;break;}middleware=middlewareRegistry[i];if(!(!middleware.condition||middleware.condition(options))){_context2.next=11;break;}_context2.next=11;return _regenerator.default.awrap(callMiddleWare(middlewareRegistry[i].middleware));case 11:i++;_context2.next=6;break;case 14:return _context2.abrupt(\"return\",document);case 15:case\"end\":return _context2.stop();}}},null,null,null,Promise);}var FontOptimizerMiddleware=function(){function FontOptimizerMiddleware(){(0,_classCallCheck2.default)(this,FontOptimizerMiddleware);this.mutate=function _callee(markup,fontDefinitions,options){var result;return _regenerator.default.async(function _callee$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:result=markup;if(options.getFontDefinition){_context3.next=3;break;}return _context3.abrupt(\"return\",markup);case 3:fontDefinitions.forEach(function(fontDef){var _fontDef=(0,_slicedToArray2.default)(fontDef,2),url=_fontDef[0],nonce=_fontDef[1];var fallBackLinkTag=\"<link rel=\\\"stylesheet\\\" href=\\\"\"+url+\"\\\"/>\";if(result.indexOf(\"<style data-href=\\\"\"+url+\"\\\">\")>-1||result.indexOf(fallBackLinkTag)>-1){return;}var fontContent=options.getFontDefinition?options.getFontDefinition(url):null;if(!fontContent){result=result.replace('</head>',fallBackLinkTag+\"</head>\");}else{var nonceStr=nonce?\" nonce=\\\"\"+nonce+\"\\\"\":'';result=result.replace('</head>',\"<style data-href=\\\"\"+url+\"\\\"\"+nonceStr+\">\"+fontContent+\"</style></head>\");}});return _context3.abrupt(\"return\",result);case 5:case\"end\":return _context3.stop();}}},null,null,null,Promise);};}(0,_createClass2.default)(FontOptimizerMiddleware,[{key:\"inspect\",value:function inspect(originalDom,options){if(!options.getFontDefinition){return;}var fontDefinitions=[];originalDom.querySelectorAll('link').filter(function(tag){return tag.getAttribute('rel')==='stylesheet'&&tag.hasAttribute('data-href')&&_constants.OPTIMIZED_FONT_PROVIDERS.some(function(url){var dataHref=tag.getAttribute('data-href');return dataHref?dataHref.startsWith(url):false;});}).forEach(function(element){var url=element.getAttribute('data-href');var nonce=element.getAttribute('nonce');if(url){fontDefinitions.push([url,nonce]);}});return fontDefinitions;}}]);return FontOptimizerMiddleware;}();var ImageOptimizerMiddleware=function(){function ImageOptimizerMiddleware(){(0,_classCallCheck2.default)(this,ImageOptimizerMiddleware);this.mutate=function _callee2(markup,imgPreloads){var result,imagePreloadTags;return _regenerator.default.async(function _callee2$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:result=markup;imagePreloadTags=imgPreloads.filter(function(imgHref){return!preloadTagAlreadyExists(markup,imgHref);}).reduce(function(acc,imgHref){return acc+(\"<link rel=\\\"preload\\\" href=\\\"\"+imgHref+\"\\\" as=\\\"image\\\"/>\");},'');return _context4.abrupt(\"return\",result.replace(/<link rel=\"preload\"/,imagePreloadTags+\"<link rel=\\\"preload\\\"\"));case 3:case\"end\":return _context4.stop();}}},null,null,null,Promise);};}(0,_createClass2.default)(ImageOptimizerMiddleware,[{key:\"inspect\",value:function inspect(originalDom){var imgPreloads=[];var imgElements=originalDom.querySelectorAll('img');var eligibleImages=[];for(var i=0;i<imgElements.length;i++){if(isImgEligible(imgElements[i])){eligibleImages.push(imgElements[i]);}if(eligibleImages.length>=MAXIMUM_IMAGE_PRELOADS){break;}}for(var _i=0,_eligibleImages=eligibleImages;_i<_eligibleImages.length;_i++){var imgEl=_eligibleImages[_i];var src=imgEl.getAttribute('src');if(src){imgPreloads.push(src);}}return imgPreloads;}}]);return ImageOptimizerMiddleware;}();function isImgEligible(imgElement){var imgSrc=imgElement.getAttribute('src');return!!imgSrc&&sourceIsSupportedType(imgSrc)&&imageIsNotTooSmall(imgElement)&&imageIsNotHidden(imgElement);}function preloadTagAlreadyExists(html,href){var escapedHref=(0,_escapeStringRegexp.default)(href);var regex=new RegExp(\"<link[^>]*href[^>]*\"+escapedHref);return html.match(regex);}function imageIsNotTooSmall(imgElement){if(!(imgElement.hasAttribute('height')&&imgElement.hasAttribute('width'))){return true;}try{var heightAttr=imgElement.getAttribute('height');var widthAttr=imgElement.getAttribute('width');if(!heightAttr||!widthAttr){return true;}if(parseInt(heightAttr)*parseInt(widthAttr)<=IMAGE_PRELOAD_SIZE_THRESHOLD){return false;}}catch(err){return true;}return true;}function imageIsNotHidden(imgElement){var activeElement=imgElement;while(activeElement.parentNode){if(activeElement.hasAttribute('hidden')){return false;}activeElement=activeElement.parentNode;}return true;}function sourceIsSupportedType(imgSrc){return!imgSrc.includes('.svg');}registerPostProcessor('Inline-Fonts',new FontOptimizerMiddleware(),function(options){return options.optimizeFonts||process.env.__NEXT_OPTIMIZE_FONTS;});registerPostProcessor('Preload Images',new ImageOptimizerMiddleware(),function(options){return options.optimizeImages||process.env.__NEXT_OPTIMIZE_IMAGES;});var _default=processHTML;exports.default=_default;","map":null,"metadata":{},"sourceType":"script"}