{"ast":null,"code":"import _slicedToArray from\"@babel/runtime/helpers/slicedToArray\";import _defineProperty from\"@babel/runtime/helpers/defineProperty\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly){symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});}keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import React,{useCallback,useEffect,useMemo,useState}from'react';import{AudioRecorder,BunnyChat,ImageUploader,Preparing,StickerPicker}from\"../../../components\";import{useDispatch,useSelector}from'react-redux';import{isLoaded,useFirestore,useFirestoreConnect}from'react-redux-firebase';import{firestoreTimestampToDate,uuidV4}from\"../../../utils\";import Keyboard from\"react-native-web/dist/exports/Keyboard\";import SafeAreaView from\"react-native-web/dist/exports/SafeAreaView\";import TouchableOpacity from\"react-native-web/dist/exports/TouchableOpacity\";import{IcoMoon}from\"../../../components/UI\";import{makeStyles}from\"./styles\";import{useBunnyKit}from\"../../../hooks/bunny-kit\";import{collectSysError}from\"../../../store/actions\";export function ChatRoomScreen(_ref){var route=_ref.route,navigation=_ref.navigation;var conversationId=route.params.conversationId;var firestore=useFirestore();var _useBunnyKit=useBunnyKit(),sizeLabor=_useBunnyKit.sizeLabor,themeLabor=_useBunnyKit.themeLabor,authLabor=_useBunnyKit.authLabor,wp=_useBunnyKit.wp;var authResult=authLabor.authResult;var user=authResult.user;var dispatch=useDispatch();var styles=makeStyles(sizeLabor,themeLabor);useFirestoreConnect([{collection:'chatMessages',orderBy:['createdAt','desc'],where:[['conversationId','==',conversationId]]}]);var chatMessages=useSelector(function(state){return state.firestoreState.ordered.chatMessages;});useEffect(function(){return function(){firestore.get({collection:'chatMessages',limit:0}).then();};},[]);var chatMessagesAdapted=chatMessages==null?void 0:chatMessages.map(function(serverItem){return _objectSpread(_objectSpread({},serverItem),{},{createdAt:firestoreTimestampToDate(serverItem.createdAt)});});var memoizedUser=useMemo(function(){if(!user){return{_id:'defaultId',avatar:'',name:'defaultName'};}var firebaseUser=user.firebaseUser,storedUser=user.storedUser;if(firebaseUser){return{_id:firebaseUser.uid||'defaultId',avatar:(storedUser==null?void 0:storedUser.photoURL)||'',name:firebaseUser.displayName||'defaultName'};}},[user]);var _useState=useState(true),_useState2=_slicedToArray(_useState,2),isShowAudioButton=_useState2[0],setIsShowAudioButton=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),isShowStickerPicker=_useState4[0],setIsShowStickerPicker=_useState4[1];var chatAssetsPath=\"/chatAssets/\"+(memoizedUser==null?void 0:memoizedUser._id);var generateMessage=function generateMessage(type,payload,needMerge){var text='',image='',audio='',video='',sticker='';switch(type){case'IMAGE':image=payload||'';break;case'AUDIO':audio=payload||'';break;case'STICKER_GIF':sticker=payload||'';break;case'MESSAGE':text=payload||'';break;case'VIDEO':video=payload||'';break;default:break;}return _objectSpread({_id:uuidV4(),createdAt:firestore.FieldValue.serverTimestamp(),conversationId:conversationId,type:type,user:memoizedUser,text:text,image:image,sticker:sticker,audio:audio,video:video,received:false,pending:true,sent:false},needMerge);};var handleSend=useCallback(function _callee(){var messages,msg,_args=arguments;return _regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:messages=_args.length>0&&_args[0]!==undefined?_args[0]:[];msg=generateMessage('MESSAGE',messages[0].text);_context.next=4;return _regeneratorRuntime.awrap(storeMessage(msg));case 4:case\"end\":return _context.stop();}}},null,null,null,Promise);},[]);var storeMessage=function storeMessage(msg){return _regeneratorRuntime.async(function storeMessage$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return _regeneratorRuntime.awrap(firestore.set(\"chatMessages/\"+msg._id,msg));case 2:_context2.next=4;return _regeneratorRuntime.awrap(setSent(msg));case 4:case\"end\":return _context2.stop();}}},null,null,null,Promise);};var setSent=function setSent(msg){return _regeneratorRuntime.async(function setSent$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return _regeneratorRuntime.awrap(firestore.update(\"chatMessages/\"+msg._id,{sent:true,pending:false}));case 2:case\"end\":return _context3.stop();}}},null,null,null,Promise);};var setReceived=function setReceived(msg){return _regeneratorRuntime.async(function setReceived$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(!((memoizedUser&&memoizedUser._id)!==(msg==null?void 0:msg.user._id))){_context4.next=3;break;}_context4.next=3;return _regeneratorRuntime.awrap(firestore.update(\"chatMessages/\"+msg._id,{received:true}));case 3:case\"end\":return _context4.stop();}}},null,null,null,Promise);};return React.createElement(SafeAreaView,{style:{flex:1}},isLoaded(chatMessages)?React.createElement(React.Fragment,null,React.createElement(BunnyChat,{isDebug:false,alwaysShowSend:true,inverted:true,messages:chatMessagesAdapted,onSend:function _callee2(messages){return _regeneratorRuntime.async(function _callee2$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:console.log('onSend',messages);_context5.next=3;return _regeneratorRuntime.awrap(handleSend(messages));case 3:case\"end\":return _context5.stop();}}},null,null,null,Promise);},user:memoizedUser,textInputProps:{onFocus:function onFocus(){setIsShowStickerPicker(false);}},onInputTextChanged:function onInputTextChanged(text){setIsShowAudioButton(!text);},onMessageReadyForDisplay:function _callee3(currentMessage){return _regeneratorRuntime.async(function _callee3$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.next=2;return _regeneratorRuntime.awrap(setReceived(currentMessage));case 2:case\"end\":return _context6.stop();}}},null,null,null,Promise);},onMessageLoadError:function onMessageLoadError(e,currentMessage){dispatch(collectSysError(e));},renderActions:function renderActions(){return React.createElement(React.Fragment,null,React.createElement(TouchableOpacity,{onPress:function onPress(){Keyboard.dismiss();setIsShowStickerPicker(!isShowStickerPicker);}},React.createElement(IcoMoon,{name:\"chat4\",style:styles.stickerPickerIcon})),React.createElement(ImageUploader,{isDeleteFromServerWhenUpload:false,path:chatAssetsPath,renderPreview:function renderPreview(_ref2){var toggleModal=_ref2.toggleModal;return React.createElement(TouchableOpacity,{onPress:function onPress(){toggleModal();}},React.createElement(IcoMoon,{name:\"paperclip\",size:wp(16),style:styles.mediaLibraryPickerIcon}));},onUploaded:function _callee4(imageSource,type){var mediaType,msg;return _regeneratorRuntime.async(function _callee4$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:mediaType='';_context7.t0=type;_context7.next=_context7.t0==='image'?4:_context7.t0==='video'?6:8;break;case 4:mediaType='IMAGE';return _context7.abrupt(\"break\",8);case 6:mediaType='VIDEO';return _context7.abrupt(\"break\",8);case 8:msg=generateMessage(mediaType,imageSource.uri);_context7.next=11;return _regeneratorRuntime.awrap(storeMessage(msg));case 11:case\"end\":return _context7.stop();}}},null,null,null,Promise);}}));},renderSend:function renderSend(props){var text=props.text,onSend=props.onSend;return React.createElement(React.Fragment,null,isShowAudioButton?React.createElement(AudioRecorder,{isUpload:true,uploadPath:chatAssetsPath,onValueChanged:function _callee5(uri){var messageNeedSent;return _regeneratorRuntime.async(function _callee5$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:messageNeedSent=generateMessage('AUDIO',uri);_context8.next=3;return _regeneratorRuntime.awrap(storeMessage(messageNeedSent));case 3:case\"end\":return _context8.stop();}}},null,null,null,Promise);}}):React.createElement(TouchableOpacity,{onPress:function onPress(){if(text&&onSend&&memoizedUser){onSend(generateMessage('MESSAGE',text),true);}}},React.createElement(IcoMoon,{name:\"paperplane1\",style:styles.sendIcon})));}}),React.createElement(StickerPicker,{isShow:isShowStickerPicker,onValueChanged:function _callee6(uri){var msg;return _regeneratorRuntime.async(function _callee6$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:msg=generateMessage('STICKER_GIF',uri);_context9.next=3;return _regeneratorRuntime.awrap(storeMessage(msg));case 3:case\"end\":return _context9.stop();}}},null,null,null,Promise);}})):React.createElement(Preparing,null));}","map":null,"metadata":{},"sourceType":"module"}